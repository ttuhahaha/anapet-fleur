function newpetal(){for(let flID=0;flID<layers.length;flID++)for(let petalcount=0;petalcount<layers[flID].petals;petalcount++)petals.push(new Petal(flID,petalcount,petals.length))}class Petal{constructor(flID,petalcount,ID){let layer=layers[flID];this.flID=flID,this.petalcount=petalcount;let rotation=home.heading()+flID;this.mid=sw*(TWO_PI/layer.petals)+petalcount*(TWO_PI/layer.petals)+rotation,this.petalcenter=p5.Vector.fromAngle(this.mid+(noise(petalcount)-.5)/2,layer.t3R),this.particles=[],this.angle=petalcount*(TWO_PI/layer.petals)+rotation,layer.closed&&(this.petalcenter.mult(noise(petalcount)),4==TYPE&&this.petalcenter.mult(noise(petalcount))),this.petalcenter.add(layer.thome),this.createparticle(layer,ID)}createparticle(layer,ID){for(let i=wr;i<=1-wr;i+=this.pointy?3/(layer.R*Q):1/(layer.R*Q)){let a=i*(TWO_PI/layer.petals)+this.angle;this.particles.push(new Particle(this,a,layer,ID))}this.particles.forEach(x=>{nzr()>.73&&(x.LSstep*=1.1),3==this.particles.indexOf(x)&&(x.LSstep*=1.8)})}drawpetal(){if(frameCount/10>this.flID)for(let p of this.particles)p.t<1&&(p.update(),!p.outside()&&p.t>p.start&&p.draw(),p.prevpos=p.pos.copy())}checkangle(){abs(degrees(this.angle+this.flID/2)%360)<frameCount%1e3/2&&abs(degrees(this.angle+this.flID/2)%360)>(frameCount-1)%1e3/2&&this.particles.forEach(x=>x.redefine(1))}seclayer(){if(this.flID<2)for(let p of this.particles){for(;p.t<1;)p.update(),p.drawseclayer(),p.prevpos=p.pos.copy();p.redefine()}}}class Particle{constructor(parent,angle,layer,ID){this.pos=this.prevpos=home.copy(),this.t=this.start=0,this.parent=ID,this.LS=1==TYPE?map(angle-parent.mid,-1,1,-5,0):map(abs(angle-parent.mid),0,1,-10,0),this.LS0=this.LS,this.hu=100*(noise(angle)-.5)+hu+10*parent.flID;let PQ=floor(3*(2*bx-parent.flID));this.speed=(noise(this.hu)/2+.5)/PQ,this.LSstep=(noise(this.hu)/2+.5)*(40-this.LS)/PQ,4==TYPE&&(this.t=.6+parent.flID/40,this.speed*=.4),this.T1=p5.Vector.fromAngle(angle,layer.R),this.T1.add(home),(layer.pointy||layer.closed&&4!=TYPE)&&(angle=parent.mid),this.T2=p5.Vector.fromAngle(angle,layer.t2R),this.T2.add(layer.thome),this.halo=random()>.99,random()>.9&&(this.speed*=1.3)}update(){this.LS+=this.LSstep,this.pos=this.updatepos(this.t),this.t+=this.speed,this.t>.95&&feature%3<1&&!this.sparkle&&petals[this.parent].particles.forEach(p=>p.t=1.1)}outside(){let x=this.prevpos.x+tx,y=this.prevpos.y+ty;return x>width+3*bx||x<-3*bx||y>height+3*bx||y<-3*bx}updatepos(t){let x=(1-t)**3*home.x+3*(1-t)**2*t*this.T1.x+3*(1-t)*t**2*this.T2.x+t**3*petals[this.parent].petalcenter.x,y=(1-t)**3*home.y+3*(1-t)**2*t*this.T1.y+3*(1-t)*t**2*this.T2.y+t**3*petals[this.parent].petalcenter.y;return createVector(x,4==TYPE?y/2:y)}sw(s){let sw=this.LS/150;return 4==TYPE?sw/=3:feature%2<1&&0!=TYPE&&null==s&&(sw/=20),max(0,sw*bx)}color(l,a){return color((this.hu+this.LS*(feature%4))%360,100,max(l||this.LS,4),a||1)}line(canvas){canvas.strokeWeight(this.sw()),canvas.line(this.pos.x+tx,this.pos.y+ty,this.prevpos.x+tx,this.prevpos.y+ty)}draw(){this.sparkle&&g1.blendMode(LIGHTEST),g1.stroke(this.color()),this.line(g1),this.drawsparkle(),this.halo&&this.LS>13&&this.t<.8&&petals[this.parent].flID<4&&this.drawhalo()}drawseclayer(){let x=4==TYPE?petals[this.parent].flID/2+1.3:1.5,y=4==TYPE?4*(x-1):1;g2.stroke(this.color()),g2.strokeWeight(.01),g2.line(this.prevpos.x*x-y*home.x+tx,this.prevpos.y*x-y*home.y+ty,this.pos.x*x-y*home.x+tx,this.pos.y*x-y*home.y+ty)}drawsparkle(){stroke(this.color(this.sparkle?this.LS+50:4*this.LS)),strokeWeight(this.sw(1)),this.sparkle?line(this.pos.x,this.pos.y,this.prevpos.x,this.prevpos.y):point(this.pos.x,this.pos.y)}redefine(x){random()>.5&&(this.t=4==TYPE?.6+petals[this.parent].flID/40:.2,this.hu+=200,this.pos=this.prevpos=home.copy(),this.LS=this.LS0,x&&(this.sparkle=!0,this.start=random(.3,.4)),this.halo=random()>.98)}drawhalo(){for(i=5;i>1;i--)strokeWeight(nzr()*(this.LS/5-i)*bx*2),stroke(this.color(this.LS+40,.05)),point(this.pos.x*this.t*5,4==TYPE?1.2*this.pos.y-1.2*home.y:2*this.pos.y+1-2*home.y)}}