function newpetal(){for(let flID=1;flID<=layers.length;flID++)for(let petalNum=0;petalNum<layers[flID-1].petals;petalNum++)petals.push(new Petal(flID,petalNum,layers[flID-1],TWO_PI/layers[flID-1].petals))}class Petal{constructor(flID,petalNum,layer,angle){this.flID=flID,this.petalNum=petalNum;let rotation=home.heading()+flID;this.angle=petalNum*angle+rotation,this.mid=sw*angle+this.angle,this.petalcenter=calculateT(flID==layers.length?layer.t3R*nzm(.5,1):6==feature?layer.t3R*nzm(.6,1.3):layer.t3R*nzm(.7,1.1),this.mid,layer.thome),this.particles=[],this.createparticle(layer,angle),6==TYPE&&(this.thome=layer.thome)}createparticle(layer,angle){let y=PI-2*Math.acos(.5/layer.t2R);layer.pointy&&(y*=2),TYPE>8&&(y*=2),6==TYPE&&(y/=18);for(let i=wr;i<=angle-wr;i+=y)this.particles.push(new Particle(this,i+this.angle,layer));if(9==TYPE)for(;this.particles.length>5;)this.particles.splice(floor(random(this.particles.length)),2);8==feature&&this.particles.forEach(x=>{(this.particles.indexOf(x)<1||this.particles.indexOf(x)>this.particles.length-2)&&(x.thick=1)})}drawpetal(){switch(drawstyle){case 0:this.particles[2*(frameCount-50)%this.particles.length].redefine(),this.particles[(2*(frameCount-50)+1)%this.particles.length].redefine();break;case 1:frameCount>100?this.randomredefine():this.particles.forEach(p=>floor(50*p.t0)==frameCount%50&&p.redefine());break;case 2:(frameCount-40)/10==this.flID?this.particles.forEach(p=>p.redefine()):this.randomredefine(1);break;case 3:TYPE<9?frameCount-47==this.flID?this.particles.forEach(p=>p.redefine()):this.flID<3&&this.randomredefine(1):this.flID<3&&random()>.9?this.randomredefine(1):this.flID>2&&this.particles.forEach(p=>{floor(100*p.t0)==(frameCount-50)%100&&p.redef<1&&p.redefine()})}for(let p of this.particles)p.dead()||(p.update(),p.draw(),p.prevpos=p.pos.copy())}seclayer(){if(TYPE<10||nzb(.6))for(let p of this.particles)if(nzb(.6))for(p.t=Math.random(.4,.7),p.update(),p.prevpos=p.pos.copy();p.t<p.maxt;)p.update(),p.drawseclayer(),p.prevpos=p.pos.copy()}randomredefine(x){return this.particles[floor(random(this.particles.length))].redefine(x)}}class Particle{constructor(parent,angle,layer){this.parent=petals.length,this.pos=this.prevpos=home,this.redef=0,this.t=1,TYPE>8&&parent.flID>4?this.t0=nzr():6==TYPE&&nzb(.3)?this.t0=1-nzr()/1.4:4==TYPE?this.t0=.5+parent.flID/30-nzr()/3:this.t0=0,this.halo=Math.random()>max(.99,1-1/(layers.length*layers[0].petals));let LS=abs(angle-parent.mid)*noise(angle);this.speed=map(noise(20*LS),0,1,.005,.06),2==feature&&(this.speed*=8),(4==TYPE||this.halo)&&(this.speed/=2),6==feature&&(this.speed=parent.particles.length%30/150),6==TYPE&&(this.angle=angle,angle=parent.mid),this.T1=calculateT(layer.R,angle,home),layer.pointy&&(angle=parent.mid),this.T2=calculateT(4!=feature?layer.t2R:layer.t2R*nzm(.4,1),angle,layer.thome),9==TYPE&&this.T2.mult(nzm(.6,1));let thishu=hu+parent.flID/layers.length*(0==colornoise?150:20);this.color0=thishu-angle*(1==colornoise?25:4),this.color1=thishu+(2==colornoise?200:30),this.maxt=glitch<.5?1-glitch*noise(10*this.speed):1,6==TYPE&&(this.point=calculateT(this.T2.mag()/9,8*this.angle,parent.petalcenter))}update(){this.t+=this.speed,this.t>=this.maxt&&(this.t=this.maxt,particleslength--),this.pos=this.updatepos(this.t),6==feature&&(this.speed=.2-this.speed)}outside(){let x=this.prevpos.x+tx,y=this.prevpos.y+ty,z=(x>width+bx||x<-bx||y>height+bx||y<-bx)&&this.t<1&&4!=TYPE;return z&&(particleslength--,this.t=1.1),z}dead(){return this.t>=this.maxt||this.outside()}updatepos(t){let x,y;return 6==TYPE?(x=(1-t)**3*home.x+3*(1-t)**2*t*this.T2.x+3*(1-t)*t**2*petals[this.parent].petalcenter.x+t**3*this.point.x,y=(1-t)**3*home.y+3*(1-t)**2*t*this.T2.y+3*(1-t)*t**2*petals[this.parent].petalcenter.y+t**3*this.point.y):(x=(1-t)**3*home.x+3*(1-t)**2*t*this.T1.x+3*(1-t)*t**2*this.T2.x+t**3*petals[this.parent].petalcenter.x,y=(1-t)**3*home.y+3*(1-t)**2*t*this.T1.y+3*(1-t)*t**2*this.T2.y+t**3*petals[this.parent].petalcenter.y),createVector(x,4==TYPE?y/2:y)}sw(){return this.t*bx/50}color(){let t=this.t-this.speed;(this.redef>1||0==drawstyle)&&(t-=this.t0),10==TYPE&&(t+=.3);let h=map(t,0,1,this.color0,this.color1)%360,l=80*t+5,a=t;return 4!=TYPE&&6!=TYPE||(a=a**2),9==TYPE&&this.redef<2&&(a=(a+.3)**3),(this.t>=this.maxt||this.redef>1)&&(l+=30),this.thick&&(a*=20),6==feature&&(l+=20,a*=2),color(h,90,l,a/feature)}draw(){(this.redef<2||2!=feature&&3==drawstyle)&&(g1.stroke(this.color()),g1.strokeWeight(this.sw()),g1.line(this.pos.x,this.pos.y,this.prevpos.x,this.prevpos.y)),this.t>this.t0&&(this.sparkle&&this.drawsparkle(),this.halo&&0!=drawstyle&&this.drawhalo())}drawseclayer(){let y=4==TYPE?2:1;g2.stroke(this.color()),g2.strokeWeight(bx),g2.line(2*this.prevpos.x-y*home.x,2*this.prevpos.y-y*home.y,2*this.pos.x-y*home.x,2*this.pos.y-y*home.y)}drawsparkle(){stroke(100),strokeWeight((this.t-this.t0)*bx/5),line(this.pos.x,this.pos.y,this.prevpos.x,this.prevpos.y)}drawhalo(){for(i=3;i>1;i--)strokeWeight(nzr()*min((5*this.t-i)*bx*2,4*bx)),stroke(0,0,100,.05),point(4==TYPE||6==feature?this.pos.x:2*this.pos.x,4==TYPE?2.5*this.pos.y:1.5*this.pos.y)}redefine(second){if(this.redef<1&&!second)0==drawstyle&&(this.t0=min((frameCount-50)/400,this.maxt-.4)),this.t=4==TYPE||6==TYPE||TYPE>9?this.t0:0,this.pos=this.prevpos=this.updatepos(this.t),this.sparkle=nzb(.7),this.redef++,particleslength++;else{let maxpart=1==drawstyle&&2==feature?1:2==drawstyle?nzb(.9):3==drawstyle?5:feature>1&&TYPE>8?nzb(.9):10,filter=this.t<=this.maxt&&particleslength<maxpart;feature>1&&3!=drawstyle&&0!=drawstyle&&(filter=filter&&nzb(.7)),0==drawstyle&&floor(frameCount/20)%petals.length+10!=this.parent&&(filter=!1),filter&&(feature<1&&(this.speed*=.5),this.sparkle=this.halo=!0,this.t=this.t0=.4+nzr()/2,this.pos=this.prevpos=this.updatepos(this.t),this.redef++,second&&this.redef++,particleslength++)}}}function calculateT(radius,angle,thome){6!=feature&&(radius+=noise(3*angle)*bx*(6==TYPE?8:4==TYPE?15:5));let result=createVector(radius*Math.cos(angle),radius/perspective*Math.sin(angle));return result.rotate(direction+1.6),result.add(thome),result}function stem(){let x=home.copy().add(p5.Vector.fromAngle(direction,120*bx));for(let i=5;i>1;i--)strokeWeight(nzr()*(1-frameCount/60)*bx*9),stroke(0,0,100,frameCount/90),point(curvePoint(home.x+5*bx,home.x+5*bx,home.x,x.x,frameCount/50),curvePoint(6*canvas.height,canvas.height-ty,home.y,x.y,frameCount/50))}